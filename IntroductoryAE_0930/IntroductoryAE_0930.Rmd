---
title: "應用計量經濟學導論"
subtitle: "實習課"
author: |
  <div style="margin-top:-18px; line-height:1.2;">
    <span style="font-weight:700;">王俊欽</span><br/>
    <span style="font-weight:700;">d14627001@ntu.edu.tw</span><br/>
    <span style="font-weight:700;">臺灣大學農業經濟研究所, 統計碩士學位學程</span><br/>
    <span style="font-weight:700;">2025/09/30</span><br/>
    &nbsp;
  </div>
output:
  xaringan::moon_reader:
    self_contained: true
    css: xaringan-themer.css
    #css: [xaringan-themer.css, zh-CN.css]
    #lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---
```{r}

```

layout: true
background-image: url(https://www.agec.ntu.edu.tw/uploads/asset/data/675f864c74ccc38a768f8254/%E6%9C%AA%E4%BE%86%E5%B1%95%E6%9C%9B%E5%9C%96%E7%89%87.png)
background-position: 98% 2%
background-size: 5%

```{r setup, include=FALSE}
library(knitr)
library(kableExtra)
library(dplyr)
library(ggplot2)
library(vistributions)
library(gginference)
setwd(dirname(rstudioapi::documentPath()))
options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(echo = TRUE, tidy = FALSE)
xaringanExtra::use_panelset()
xaringanExtra::use_clipboard()
xaringanExtra::use_extra_styles(hover_code_line = TRUE)
```
```{r xaringanExtra, echo = FALSE}
xaringanExtra::use_progress_bar(color = "#EFBE43", location = "bottom")
```
```{r xaringan-themer, include=FALSE, warning=FALSE}
library(xaringanthemer)
style_duo(
  # colors
  primary_color = "#FDF7E9",
  secondary_color = "#EFBE43",
  header_color = "#333333",
  text_color = "#333333",
  code_inline_color = colorspace::lighten("#333333"),
  text_bold_color = colorspace::lighten("#333333"),
  link_color = "#4466B0",
  title_slide_text_color = "#4466B0",

  # fonts
  header_font_google = google_font("Martel", "300", "400"),
  text_font_google = google_font("Lato"),
  code_font_google = google_font("Fira Mono")
)

style_extra_css(
  # 只針對段落 (p) 和列表 (li) 內的 `code`
  list(
    "p code, li code" = list(  
      "border" = "1px solid #F6DB96",
      "padding" = "2px 4px",
      "border-radius" = "4px"
      ),
    "ul ul" = list(
      "list-style-type" = "'▸'"  # 第二層使用三角形 (▸)
      ),
    "ul ul ul" = list(
      "list-style-type" = "'✔'"  # 第三層使用勾勾 (✔)
      ),
    # 置中
    ".middle_block" = list(
      "position" = "absolute",
      "top" = "50%",
      "left" = "50%", # 使與預設靠左距離相同
      "transform" = "translate(-50%, -50%)",
      "width" = "85%",              # 控制內文寬度（可調整）
      "text-align" = "left"         
      ),
    # 縮排
    ".indent" = list(
      "text-indent" = "2em"
      ),
    # 自動換行
    "pre code" = list(
      "white-space" = "pre-wrap",
      "word-wrap" = "break-word"
      ),
    "pre" = list(
      "border" = "none",
      "box-shadow" = "2px 2px 2px 2px #F7EEDA",
      "padding" = "0.1em",
      "background" = "none !important",
      "overflow-x" = "auto",
      "border-radius" = "1px"
      ),
    # 條列圖示顏色
    "li::marker" = list(
      "content" = "• ",
      "color" =  "#EFBE43"
      )
    )
  )

```


```{r, echo = FALSE}
options(servr.daemon = TRUE)
```



---
## Grouping Plot

上週提到，我們可以在 ggplot 中設定散點圖的顏色（**注意這邊是對 `geom_point()` 設定 `color`**）。
```{r echo = F, warning=F}
library(gapminder)
df <- gapminder
df1 <- df %>% reframe(across(lifeExp:gdpPercap, mean), .by = c(year, continent))
```
```{r out.width="45%", fig.align='center'}
ggplot(data = df1) + geom_point(mapping = aes(x = gdpPercap, y = lifeExp), color = "blue")
```

---
## Grouping Plot

- 在統計圖表中，設定 **color** 除了單純改變顏色，也可以透過設定 `mapping = aes()` 中的 `color` 來展現不同組別的屬性。
```{r}
unique(df1$continent)
```
- 例如，單看底下這張散點圖，你可以思考：或許對於不同的洲 GDP 與平均壽命可能存在不一樣的關聯性。
```{r echo = F, out.width="32%", fig.align='center'}
ggplot(data = df1) + geom_point(mapping = aes(x = gdpPercap, y = lifeExp), color = "blue")
```

---
## Grouping Plot

因此，我們在映射中加入 `color = continent` 以代表：**對於不同的洲，使用不同的顏色**來呈現散點圖的型態，資料中共有五大洲，所以會有五個顏色。

```{r out.width="42%", fig.align='center'}
ggplot(data = df1) + geom_point(mapping = aes(x = gdpPercap, y = lifeExp, color = continent), size = 3)
```

---
## Default color

ggplot2 套件有默認的顏色，會依據分組數量來填上默認的顏色以及順序。

```{r}
library(scales)
```
.pull-left[
```{r out.width="80%", fig.align='center'}
show_col(hue_pal()(4))
```
]
.pull-right[
```{r out.width="80%", fig.align='center'}
show_col(hue_pal()(6))
```
]

---
## Discrete v.s. Continuous
離散變數（Discrete）與連續變數（Continuous）會直接影響到圖形的呈現方式、刻度處理等，甚至是映射時的規則也有所差異。如在 gapminder 資料中，可簡單區分變數：

- 離散變數（Discrete）：

  - country
  
  - continent
  

- 連續變數（Continuous）：

  - lifeExp
  
  - pop
  
  - gdpPercap
  
---
## Discrete v.s. Continuous

.panelset[
.panel[.panel-name[Discrete]
顏色映射到離散變數時會產生多種**不同**顏色。
```{r out.width="35%", fig.align='center'}
df1 %>% group_by(continent) %>% summarise(gdpPercap = mean(gdpPercap, na.rm = T)) %>% 
  ggplot() + geom_point(mapping = aes(x = continent, y = gdpPercap, color = continent), size = 3)
```

]
.panel[.panel-name[Continuous]
顏色映射到連續變數時會用同色系的**漸層**色條。
```{r out.width="35%", fig.align='center'}
df1 %>% reframe(gdpPercap = mean(gdpPercap, na.rm = TRUE), .by = continent) %>%
  ggplot() + geom_point(aes(x = continent, y = gdpPercap, color = gdpPercap), size = 3)
```
]
]
---
## Discrete v.s. Continuous
那麼變數 **year** 是屬於離散（Discrete）還是連續（Continuous）變數呢?
.panelset[
.panel[.panel-name[Attribute]
首先我們先來看看 year 變數的幾種屬性。
```{r}
class(df1$year)
unique(df1$year)
```
]
.panel[.panel-name[Continuous]
由於 year 的資料型態為 interger，所以屬於連續變數（Continuous）。
.pull-left[
```{r fig1, fig.show = 'hide'}
df1 %>% reframe(gdpPercap = mean(gdpPercap, na.rm = TRUE), .by = year) %>%
  ggplot() + geom_point(aes(x = year, y = gdpPercap, color = year), size = 3)
```
]
.pull-right[
```{r ref.label='fig1', echo = FALSE, out.width="85%", fig.align='center'}
```
]
]
.panel[.panel-name[Discrete]
實際上這種斷點式的時間資料不太適合呈現連續的趨勢，而此時我們比較想分組比較每五年的GDP分布，於是我們可以將整數資料型態改為 `factor()`。
.pull-left[
```{r fig2, fig.show = 'hide'}
df1 %>% reframe(gdpPercap = mean(gdpPercap, na.rm = TRUE), .by = year) %>%
  ggplot() + geom_point(aes(x = year, y = gdpPercap, color = factor(year)), size = 3)
```
]
.pull-right[
```{r ref.label='fig2', echo = FALSE, out.width="80%", fig.align='center'}
```
]
]
]

---
## Grouping Plot
在映射 `mapping = aes()` 中，除了可以用不同顏色作為分組的表現外，也可以用 `shape`、`size`、`alpha` 來表現不同組別的資料。

.panelset[
.panel[.panel-name[shape]
.pull-left[
```{r fig3, fig.show = 'hide'}
df1 %>% reframe(gdpPercap = mean(gdpPercap, na.rm = TRUE), .by = continent) %>% 
  ggplot() + geom_point(mapping = aes(x = continent, y = gdpPercap, shape = continent), size = 3)
```
** 注意！ `shape` 無法展現連續型的變數資料。
]
.pull-right[
```{r ref.label='fig3', echo = FALSE, out.width="80%", fig.align='center'}
```
]
]
.panel[.panel-name[size]
.pull-left[
```{r fig4, fig.show = 'hide'}
df1 %>% reframe(gdpPercap = mean(gdpPercap, na.rm = TRUE), .by = continent) %>%
  ggplot() + geom_point(aes(x = continent, y = gdpPercap, size = gdpPercap))
```

]
.pull-right[
```{r ref.label='fig4', echo = FALSE, out.width="80%", fig.align='center'}
```
]
]
]

---
## Color setting
最後，必須注意設置 `color` 的位置是在映射（aes）還是幾何圖形（geom）中。
.pull-left[
```{r out.width="80%", fig.align='center'}
ggplot(data = df) + geom_point(aes(x = gdpPercap, y = lifeExp, color = "green"))
```
]
.pull-right[
```{r out.width="80%", fig.align='center'}
ggplot(data = df) + geom_point(aes(x = gdpPercap, y = lifeExp), color = "green")
```
]

---
## Global & Local
一開始學習 ggplot 的時候，因為要記的東西有點多，或是很多寫法都長得很類似，會發現好像這樣寫也可以、那樣寫也可以。事實上，當你用兩種寫法畫出同一張圖時，只是巧合，在 ggplot 中，繼承 ggplot 物件的屬性還是有順序性的。回顧繪圖的步驟：

- Global 設定

  - `ggplot()` 拿出一張白紙來畫圖
  
  - `ggplot(data = df)` 使用 df 這個材料來畫圖

- Local 設定
  - `geom_point()` 決定畫一張散點圖
  
  - `geom_point(mapping = aes(x = gdpPercap, y = lifeExp))` 指定散點圖中的 x, y 資料

---
## Global mapping
我們可以將所用資料、映射內容全部寫在 `ggplot()` 中，此時如果繪製缺乏映射內容的幾何圖形將從 Global 設置中直接繼承。

.panelset[
.panel[.panel-name[Example]
.pull-left[
按照原本的寫法，我們只告訴 ggplot 所使用的資料，再選擇想繪製的幾何圖形，並決定映射內容。
```{r fig5, fig.show = 'hide'}
ggplot(data = df1) + geom_point(mapping = aes(x = gdpPercap, y = lifeExp, color = continent))
```
]
.pull-right[
```{r ref.label = 'fig5', echo = FALSE, out.width="80%", fig.align='center'}
```
]
]
.panel[.panel-name[Global]
.pull-left[
或是我們一並將映射內容先告訴 ggplot，再指定想繪製的幾何圖形，此時幾何圖形沒有映射內容，**所以直接從主物件 ggplot  中繼承**。
```{r fig6, fig.show = 'hide'}
ggplot(data = df1, mapping = aes(x = gdpPercap, y = lifeExp, color = continent)) + geom_point()
```
]
.pull-right[
```{r ref.label = 'fig6', echo = FALSE, out.width="80%", fig.align='center'}
```
]
]
.panel[.panel-name[Advantage]
.pull-left[
直接 Global 設置的好處是同時繪製多種幾何圖形時，不須重複設置映射內容。
```{r fig7, fig.show = 'hide'}
df1 %>% reframe(gdpPercap = mean(gdpPercap, na.rm = TRUE), .by = year) %>%
  ggplot(aes(x = year, y = gdpPercap, color = year)) + geom_point() + geom_line()
```
]
.pull-right[
```{r ref.label = 'fig7', echo = FALSE, out.width="80%", fig.align='center'}
```
]
]
]

---
## Local mapping
我們也可以選擇在繪製幾何圖形時才將所有資訊寫出來，但依然不能省略 `ggplot()`。
```{r out.width="45%", fig.align='center'}
ggplot() + geom_point(data = df1, mapping = aes(x = gdpPercap, y = lifeExp, color = continent))
```

---
## Local mapping
可以只在 geom 中的 aes 設置顏色、形狀。此外，如果同時在 Global 與 Local 中設置映射內容，則 Local 中的映射內容將覆蓋掉 Global 中的映射內容。

.panelset[
.panel[.panel-name[Example]
.pull-left[
只在 Global 設置中決定映射內容，幾何圖形的屬性依然是在 geom 中設置（size）。
```{r fig8, fig.show = 'hide'}
ggplot(data = df1, mapping = aes(x = gdpPercap, y = lifeExp, color = continent)) + geom_point(size = 3)
```
]
.pull-right[
```{r ref.label = 'fig8', echo = FALSE, out.width="80%", fig.align='center'}
```
]
]
.panel[.panel-name[Local]
.pull-left[
從 Global 設置中只繼承所用資料與 x, y 的映射資料，以顏色分組的映射內容則在 Local 設置中。
```{r fig9, fig.show = 'hide'}
ggplot(data = df1, mapping = aes(x = gdpPercap, y = lifeExp)) + geom_point(aes(color = continent), size = 3)
```
]
.pull-right[
```{r ref.label = 'fig9', echo = FALSE, out.width="80%", fig.align='center'}
```
]
]
.panel[.panel-name[Replace]
.pull-left[
Global 設置中的映射內容會被 Local 設置中的映射內容取代，這邊注意在 geom 中還是要在 aes 中決定映射內容。
```{r fig10, fig.show = 'hide'}
ggplot(data = df1, mapping = aes(x = gdpPercap, y = lifeExp, color = continent)) + geom_point(aes(color = factor(year)), size = 3)
```
]
.pull-right[
```{r ref.label = 'fig10', echo = FALSE, out.width="80%", fig.align='center'}
```
]
]
]

---
## Density
不同幾何圖形顏色映射方式也不同，`color`是映射線條或點；`fill`是映射面積。
.panelset[
.panel[.panel-name[Color]
```{r out.width="40%", fig.align='center', message=F}
ggplot(data = df) + geom_density(aes(x = lifeExp, color = continent))
```
]
.panel[.panel-name[Fill]
```{r out.width="40%", fig.align='center', message=F}
ggplot(data = df) + geom_density(aes(x = lifeExp, fill = continent), alpha = 0.5)
```
]
]

---
## Histogram
回想不同的統計圖表是用來呈現什麼樣的資料特點，如：直方圖、長條圖。

```{r out.width="50%", fig.align='center', message=F}
ggplot(data = df1) + geom_histogram(aes(x = gdpPercap, fill = continent))

```
---
## Bar Chart
```{r out.width="50%", fig.align='center', message=F}
ggplot(data = df) + geom_bar(aes(x = continent, fill = continent))
```

---
## Bar Chart
呈現 2007 年 GDP 低於中位數的國家數量在五大洲分別有多少。

.pull-left[
```{r fig11, fig.show = 'hide'}
df %>% filter(year == 2007) %>% 
  mutate(mid_gdp = ifelse(gdpPercap >= median(gdpPercap), 1, 0)) %>% 
  ggplot() + geom_bar(aes(x = continent, fill = factor(mid_gdp)))
```
]
.pull-right[
```{r ref.label = 'fig11', echo = FALSE, out.width="90%", fig.align='center'}
```
]

---
## Lab Exam 1

- **考試時間：10/7（二）10:20 - 12:00**

- **考試地點：博雅 408 教室**

- **不需要自行攜帶電腦，需使用教室電腦作答**

- **可以攜帶 code、檔案、簡報等等有助於你作答的資源，請自行攜帶 USB 插入電腦**

- **考試期間不得使用網路與非教室電腦之電子產品**

---
class: center, middle, inverse
### 謝謝
#### 下周見